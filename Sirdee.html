<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Transductores Arduino</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .control-panel {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select, input {
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #3498db;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-connect {
            background: #2ecc71;
            color: white;
        }

        .btn-connect:hover:not(:disabled) {
            background: #27ae60;
        }

        .btn-disconnect {
            background: #e74c3c;
            color: white;
        }

        .btn-disconnect:hover {
            background: #c0392b;
        }

        .btn-record {
            background: #3498db;
            color: white;
        }

        .btn-record:hover:not(:disabled) {
            background: #2980b9;
        }

        .btn-export {
            background: #9b59b6;
            color: white;
        }

        .btn-export:hover {
            background: #8e44ad;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            background: #95a5a6;
            color: white;
        }

        .btn-small:hover {
            background: #7f8c8d;
        }

        .sensors-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
            grid-template-rows: auto auto auto;
        }

        .sensor-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .sensor-card.active {
            border-color: currentColor;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .sensor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .sensor-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .sensor-value {
            font-size: 24px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .sensor-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .range-input {
            width: 80px;
            padding: 5px;
            font-size: 12px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 10px;
        }

        .stats-box {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 12px;
            display: none;
        }

        .stats-box.visible {
            display: block;
        }

        .terminal-section {
            background: #2c3e50;
            border-radius: 10px;
            padding: 15px;
            color: #ecf0f1;
        }

        .terminal-output {
            background: #1a252f;
            padding: 15px;
            border-radius: 5px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .terminal-output::-webkit-scrollbar {
            width: 8px;
        }

        .terminal-output::-webkit-scrollbar-track {
            background: #1a252f;
        }

        .terminal-output::-webkit-scrollbar-thumb {
            background: #34495e;
            border-radius: 4px;
        }

        .terminal-input-group {
            display: flex;
            gap: 10px;
        }

        .terminal-input-group input {
            flex: 1;
            background: #34495e;
            color: #ecf0f1;
            border: 2px solid #2c3e50;
        }

        .command-sent {
            color: #3498db;
            font-weight: bold;
        }

        .data-table {
            width: 100%;
            font-size: 11px;
            margin-top: 10px;
            border-collapse: collapse;
        }

        .data-table th {
            background: #34495e;
            color: white;
            padding: 5px;
            text-align: center;
        }

        .data-table td {
            padding: 3px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }

        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .calibration-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .calibration-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .calibration-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .calibration-terminal {
            background: #1a252f;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 15px 0;
        }

        label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            color: #856404;
        }

        .warning-box strong {
            display: block;
            margin-bottom: 5px;
        }

        @media (max-width: 1200px) {
            .sensors-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1> Monitor de Arduino</h1>

        <div class="warning-box">
            <strong>‚ö†Ô∏è Requisitos:</strong>
            Esta aplicaci√≥n requiere <strong>Google Chrome o Microsoft Edge</strong> (versi√≥n 89 o superior) para funcionar correctamente. 
            La Web Serial API no est√° disponible en Firefox o Safari.
        </div>

        <div class="control-panel">
            <div class="control-group">
                <label>Puerto:</label>
                <select id="portSelect" disabled>
                    <option>Seleccionar puerto...</option>
                </select>
                <button id="requestPortBtn" class="btn-connect">Solicitar Puerto</button>
                <button id="connectBtn" class="btn-connect" disabled>Conectar</button>
                <button id="disconnectBtn" class="btn-disconnect" style="display:none;">Desconectar</button>
            </div>
            <div class="control-group">
                <button id="recordBtn" class="btn-record" disabled>Iniciar Captura</button>
                <button id="exportCsvBtn" class="btn-export">Exportar CSV</button>
                <button id="exportPdfBtn" class="btn-export">Exportar PDF</button>
            </div>
        </div>

        <div class="sensors-grid">
            <!-- Sensor 1 -->
            <div class="sensor-card" id="sensor1-card" style="color: #e74c3c;">
                <div class="sensor-header">
                    <div class="sensor-info">
                        <label>
                            <input type="checkbox" id="sensor1-enable">
                            <strong>Sensor 1</strong>
                        </label>
                        <span class="sensor-value" id="sensor1-value">---</span>
                    </div>
                    <div class="sensor-controls">
                        <button class="btn-small" id="sensor1-tare">Poner a 0</button>
                        <input type="number" class="range-input" id="sensor1-range" value="25.0" step="0.1">
                        <button class="btn-small" id="sensor1-set-range">Establecer Rango</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="sensor1-chart"></canvas>
                </div>
                <div class="stats-box" id="sensor1-stats">
                    <strong>Estad√≠sticas:</strong> Min: <span id="sensor1-min">-</span> | Max: <span id="sensor1-max">-</span>
                </div>
                <table class="data-table" id="sensor1-table">
                    <thead>
                        <tr><th>Tiempo (s)</th><th>Valor (mm)</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Sensor 2 -->
            <div class="sensor-card" id="sensor2-card" style="color: #3498db;">
                <div class="sensor-header">
                    <div class="sensor-info">
                        <label>
                            <input type="checkbox" id="sensor2-enable">
                            <strong>Sensor 2</strong>
                        </label>
                        <span class="sensor-value" id="sensor2-value">---</span>
                    </div>
                    <div class="sensor-controls">
                        <button class="btn-small" id="sensor2-tare">Poner a 0</button>
                        <input type="number" class="range-input" id="sensor2-range" value="25.0" step="0.1">
                        <button class="btn-small" id="sensor2-set-range">Establecer Rango</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="sensor2-chart"></canvas>
                </div>
                <div class="stats-box" id="sensor2-stats">
                    <strong>Estad√≠sticas:</strong> Min: <span id="sensor2-min">-</span> | Max: <span id="sensor2-max">-</span>
                </div>
                <table class="data-table" id="sensor2-table">
                    <thead>
                        <tr><th>Tiempo (s)</th><th>Valor (mm)</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Sensor 3 -->
            <div class="sensor-card" id="sensor3-card" style="color: #2ecc71;">
                <div class="sensor-header">
                    <div class="sensor-info">
                        <label>
                            <input type="checkbox" id="sensor3-enable">
                            <strong>Sensor 3</strong>
                        </label>
                        <span class="sensor-value" id="sensor3-value">---</span>
                    </div>
                    <div class="sensor-controls">
                        <button class="btn-small" id="sensor3-tare">Poner a 0</button>
                        <input type="number" class="range-input" id="sensor3-range" value="25.0" step="0.1">
                        <button class="btn-small" id="sensor3-set-range">Establecer Rango</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="sensor3-chart"></canvas>
                </div>
                <div class="stats-box" id="sensor3-stats">
                    <strong>Estad√≠sticas:</strong> Min: <span id="sensor3-min">-</span> | Max: <span id="sensor3-max">-</span>
                </div>
                <table class="data-table" id="sensor3-table">
                    <thead>
                        <tr><th>Tiempo (s)</th><th>Valor (mm)</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Sensor 4 -->
            <div class="sensor-card" id="sensor4-card" style="color: #f39c12;">
                <div class="sensor-header">
                    <div class="sensor-info">
                        <label>
                            <input type="checkbox" id="sensor4-enable">
                            <strong>Sensor 4</strong>
                        </label>
                        <span class="sensor-value" id="sensor4-value">---</span>
                    </div>
                    <div class="sensor-controls">
                        <button class="btn-small" id="sensor4-tare">Poner a 0</button>
                        <input type="number" class="range-input" id="sensor4-range" value="25.0" step="0.1">
                        <button class="btn-small" id="sensor4-set-range">Establecer Rango</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="sensor4-chart"></canvas>
                </div>
                <div class="stats-box" id="sensor4-stats">
                    <strong>Estad√≠sticas:</strong> Min: <span id="sensor4-min">-</span> | Max: <span id="sensor4-max">-</span>
                </div>
                <table class="data-table" id="sensor4-table">
                    <thead>
                        <tr><th>Tiempo (s)</th><th>Valor (mm)</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Sensor 5 -->
            <div class="sensor-card" id="sensor5-card" style="color: #9b59b6;">
                <div class="sensor-header">
                    <div class="sensor-info">
                        <label>
                            <input type="checkbox" id="sensor5-enable">
                            <strong>Sensor 5</strong>
                        </label>
                        <span class="sensor-value" id="sensor5-value">---</span>
                    </div>
                    <div class="sensor-controls">
                        <button class="btn-small" id="sensor5-tare">Poner a 0</button>
                        <input type="number" class="range-input" id="sensor5-range" value="25.0" step="0.1">
                        <button class="btn-small" id="sensor5-set-range">Establecer Rango</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="sensor5-chart"></canvas>
                </div>
                <div class="stats-box" id="sensor5-stats">
                    <strong>Estad√≠sticas:</strong> Min: <span id="sensor5-min">-</span> | Max: <span id="sensor5-max">-</span>
                </div>
                <table class="data-table" id="sensor5-table">
                    <thead>
                        <tr><th>Tiempo (s)</th><th>Valor (mm)</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Terminal Serial (al lado del Sensor 5) -->
            <div class="sensor-card terminal-section">
                <h3 style="margin-bottom: 10px; color: #ecf0f1;">üìü Terminal Serial</h3>
                <div class="terminal-output" id="terminalOutput"></div>
                <div class="terminal-input-group">
                    <input type="text" id="terminalInput" placeholder="Escribe un comando...">
                    <button class="btn-small" id="sendBtn">Enviar</button>
                    <button class="btn-small" id="enterBtn">ENTER</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Calibraci√≥n -->
    <div class="calibration-modal" id="calibrationModal">
        <div class="modal-content">
            <div class="modal-header">‚öôÔ∏è Panel de Calibraci√≥n</div>
            <div class="calibration-terminal" id="calibrationTerminal"></div>
            <div class="calibration-buttons">
                <label>Calibrar T:</label>
                <button class="btn-small" id="calibrate1">1</button>
                <button class="btn-small" id="calibrate2">2</button>
                <button class="btn-small" id="calibrate3">3</button>
                <button class="btn-small" id="calibrate4">4</button>
                <button class="btn-small" id="calibrate5">5</button>
                <button class="btn-record" id="saveCalibration">Guardar (S)</button>
                <button class="btn-small" id="calibrationEnter">ENTER</button>
            </div>
            <button class="btn-disconnect" id="closeCalibration" style="width: 100%; margin-top: 15px;">Cerrar</button>
        </div>
    </div>

    <script>
        // Verificar soporte de Web Serial API
        if (!('serial' in navigator)) {
            alert('‚ö†Ô∏è Tu navegador no soporta Web Serial API. Por favor, usa Google Chrome o Microsoft Edge (versi√≥n 89+).');
        }

        // Variables globales
        let port = null;
        let reader = null;
        let writer = null;
        let isConnected = false;
        let isRecording = false;
        let startTime = Date.now();

        const sensorColors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6'];
        const sensors = {
            1: { enabled: false, values: [], times: [], allValues: [], allTimes: [], offset: 0, isTared: false, min: null, max: null, chart: null, maxRange: 25.0 },
            2: { enabled: false, values: [], times: [], allValues: [], allTimes: [], offset: 0, isTared: false, min: null, max: null, chart: null, maxRange: 25.0 },
            3: { enabled: false, values: [], times: [], allValues: [], allTimes: [], offset: 0, isTared: false, min: null, max: null, chart: null, maxRange: 25.0 },
            4: { enabled: false, values: [], times: [], allValues: [], allTimes: [], offset: 0, isTared: false, min: null, max: null, chart: null, maxRange: 25.0 },
            5: { enabled: false, values: [], times: [], allValues: [], allTimes: [], offset: 0, isTared: false, min: null, max: null, chart: null, maxRange: 25.0 }
        };

        // Inicializar gr√°ficas
        function initCharts() {
            for (let i = 1; i <= 5; i++) {
                const ctx = document.getElementById(`sensor${i}-chart`).getContext('2d');
                sensors[i].chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: `Sensor ${i}`,
                            data: [],
                            borderColor: sensorColors[i - 1],
                            backgroundColor: sensorColors[i - 1] + '20',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'Tiempo (s)' }
                            },
                            y: {
                                title: { display: true, text: 'Valor (mm)' },
                                ticks: {
                                    callback: function(value) {
                                        return value.toFixed(4);
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Solicitar puerto serial
        document.getElementById('requestPortBtn').addEventListener('click', async () => {
            try {
                port = await navigator.serial.requestPort();
                document.getElementById('connectBtn').disabled = false;
                addToTerminal('‚úÖ Puerto serial seleccionado correctamente');
            } catch (error) {
                addToTerminal('‚ùå Error al solicitar puerto: ' + error.message);
            }
        });

        // Conectar
        document.getElementById('connectBtn').addEventListener('click', async () => {
            if (!port) {
                alert('Primero debes solicitar un puerto serial');
                return;
            }

            try {
                await port.open({ baudRate: 9600 });
                isConnected = true;

                // Configurar lectura
                const textDecoder = new TextDecoderStream();
                port.readable.pipeTo(textDecoder.writable);
                reader = textDecoder.readable.getReader();

                // Configurar escritura
                const textEncoder = new TextEncoderStream();
                textEncoder.readable.pipeTo(port.writable);
                writer = textEncoder.writable.getWriter();

                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('disconnectBtn').style.display = 'inline-block';
                document.getElementById('recordBtn').disabled = false;
                document.getElementById('requestPortBtn').disabled = true;

                addToTerminal('‚úÖ Conectado exitosamente al Arduino');
                
                // Iniciar lectura de datos
                readSerialData();

                // Mostrar modal de calibraci√≥n
                setTimeout(() => {
                    document.getElementById('calibrationModal').classList.add('show');
                    // Auto-calibrar sensores habilitados
                    autoCalibrate();
                }, 1000);

            } catch (error) {
                addToTerminal('‚ùå Error al conectar: ' + error.message);
            }
        });

        // Desconectar
        document.getElementById('disconnectBtn').addEventListener('click', async () => {
            if (reader) {
                await reader.cancel();
                reader = null;
            }
            if (writer) {
                await writer.close();
                writer = null;
            }
            if (port) {
                await port.close();
                port = null;
            }

            isConnected = false;
            document.getElementById('connectBtn').style.display = 'inline-block';
            document.getElementById('disconnectBtn').style.display = 'none';
            document.getElementById('recordBtn').disabled = true;
            document.getElementById('requestPortBtn').disabled = false;

            // Apagar LEDs
            for (let i = 1; i <= 5; i++) {
                if (sensors[i].enabled) {
                    sendCommand(`LOFF${i}\n`);
                }
            }

            addToTerminal('üîå Desconectado del Arduino');
        });

        // Leer datos del serial
        async function readSerialData() {
            let buffer = '';
            
            try {
                while (isConnected && reader) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    buffer += value;
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        const trimmedLine = line.trim();
                        if (trimmedLine) {
                            processSerialLine(trimmedLine);
                            addToTerminal(trimmedLine);
                        }
                    }
                }
            } catch (error) {
                console.error('Error leyendo serial:', error);
                addToTerminal('‚ùå Error en lectura serial: ' + error.message);
            }
        }

        // Procesar l√≠nea del serial
        function processSerialLine(line) {
            // Detectar datos de sensores
            if (line.startsWith('Pot')) {
                const parts = line.replace(/\|/g, ',').split(',');
                
                for (const part of parts) {
                    const trimmed = part.trim();
                    if (trimmed.includes(':')) {
                        const [potName, valueStr] = trimmed.split(':').map(s => s.trim());
                        const sensorNum = parseInt(potName.replace('Pot', ''));
                        
                        if (sensors[sensorNum] && valueStr) {
                            try {
                                const rawValue = parseFloat(valueStr);
                                // Invertir valor seg√∫n el rango m√°ximo
                                const processedValue = sensors[sensorNum].maxRange - rawValue;
                                const adjustedValue = processedValue - sensors[sensorNum].offset;
                                const currentTime = (Date.now() - startTime) / 1000;

                                sensors[sensorNum].values.push(adjustedValue);
                                sensors[sensorNum].times.push(currentTime);

                                // Limitar a √∫ltimos 500 puntos en memoria
                                if (sensors[sensorNum].values.length > 500) {
                                    sensors[sensorNum].values.shift();
                                    sensors[sensorNum].times.shift();
                                }

                                if (isRecording) {
                                    sensors[sensorNum].allValues.push(adjustedValue);
                                    sensors[sensorNum].allTimes.push(currentTime);

                                    if (sensors[sensorNum].min === null || adjustedValue < sensors[sensorNum].min) {
                                        sensors[sensorNum].min = adjustedValue;
                                    }
                                    if (sensors[sensorNum].max === null || adjustedValue > sensors[sensorNum].max) {
                                        sensors[sensorNum].max = adjustedValue;
                                    }
                                }

                                // Actualizar UI
                                updateSensorDisplay(sensorNum, adjustedValue);
                            } catch (e) {
                                console.error('Error procesando valor:', e);
                            }
                        }
                    }
                }
            }

            // Detectar informaci√≥n de rango
            if (line.includes('Rango=') || line.includes('Rango T')) {
                try {
                    let sensorNum, rangeValue;
                    
                    if (line.startsWith('T')) {
                        const parts = line.split(/\s+/);
                        sensorNum = parseInt(parts[0].replace('T', '').replace(':', ''));
                        rangeValue = parseFloat(parts[parts.length - 1].replace('mm', '').replace('Rango=', ''));
                    } else if (line.includes('Rango T')) {
                        const match = line.match(/Rango T(\d+).*?(\d+\.?\d*)/);
                        if (match) {
                            sensorNum = parseInt(match[1]);
                            rangeValue = parseFloat(match[2]);
                        }
                    }

                    if (sensorNum && rangeValue) {
                        const rangeInput = document.getElementById(`sensor${sensorNum}-range`);
                        if (rangeInput) {
                            rangeInput.value = rangeValue.toFixed(4);
                            sensors[sensorNum].maxRange = rangeValue;
                        }
                    }
                } catch (e) {
                    console.error('Error procesando rango:', e);
                }
            }
        }

        // Actualizar display del sensor
        function updateSensorDisplay(sensorNum, value) {
            const valueElement = document.getElementById(`sensor${sensorNum}-value`);
            valueElement.textContent = value.toFixed(4) + ' mm';

            if (sensors[sensorNum].enabled) {
                updateChart(sensorNum);
                updateTable(sensorNum);
                updateStats(sensorNum);
            }
        }

        // Actualizar gr√°fica
        function updateChart(sensorNum) {
            const sensor = sensors[sensorNum];
            const chart = sensor.chart;

            chart.data.labels = sensor.times.map(t => t.toFixed(2));
            chart.data.datasets[0].data = sensor.values;
            chart.update('none');
        }

        // Actualizar tabla
        function updateTable(sensorNum) {
            if (!isRecording) return;

            const sensor = sensors[sensorNum];
            const tbody = document.querySelector(`#sensor${sensorNum}-table tbody`);
            tbody.innerHTML = '';

            // Mostrar √∫ltimos valores del √∫ltimo segundo
            const currentTime = sensor.times[sensor.times.length - 1];
            const recentData = [];

            for (let i = sensor.times.length - 1; i >= 0; i--) {
                if (currentTime - sensor.times[i] > 1.0) break;
                recentData.unshift({
                    time: sensor.times[i],
                    value: sensor.values[i]
                });
            }

            recentData.forEach(data => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = data.time.toFixed(2);
                row.insertCell(1).textContent = data.value.toFixed(4);
            });
        }

        // Actualizar estad√≠sticas
        function updateStats(sensorNum) {
            if (!isRecording) return;

            const sensor = sensors[sensorNum];
            const statsBox = document.getElementById(`sensor${sensorNum}-stats`);
            
            if (sensor.min !== null && sensor.max !== null) {
                document.getElementById(`sensor${sensorNum}-min`).textContent = sensor.min.toFixed(4);
                document.getElementById(`sensor${sensorNum}-max`).textContent = sensor.max.toFixed(4);
                statsBox.classList.add('visible');
            }
        }

        // Enviar comando al Arduino
        async function sendCommand(command) {
            if (!writer) {
                addToTerminal('‚ùå No hay conexi√≥n activa');
                return false;
            }

            try {
                await writer.write(command);
                return true;
            } catch (error) {
                addToTerminal('‚ùå Error enviando comando: ' + error.message);
                return false;
            }
        }

        // A√±adir texto al terminal
        function addToTerminal(text) {
            const terminal = document.getElementById('terminalOutput');
            const line = document.createElement('div');
            line.textContent = text;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;

            // Tambi√©n a√±adir al terminal de calibraci√≥n si est√° visible
            const calibTerminal = document.getElementById('calibrationTerminal');
            if (calibTerminal && document.getElementById('calibrationModal').classList.contains('show')) {
                const calibLine = document.createElement('div');
                calibLine.textContent = text;
                calibTerminal.appendChild(calibLine);
                calibTerminal.scrollTop = calibTerminal.scrollHeight;
            }
        }

        // A√±adir comando enviado al terminal
        function addCommandToTerminal(cmd) {
            const terminal = document.getElementById('terminalOutput');
            const line = document.createElement('div');
            line.className = 'command-sent';
            line.textContent = '>>> ' + cmd;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;

            const calibTerminal = document.getElementById('calibrationTerminal');
            if (calibTerminal && document.getElementById('calibrationModal').classList.contains('show')) {
                const calibLine = document.createElement('div');
                calibLine.className = 'command-sent';
                calibLine.textContent = '>>> ' + cmd;
                calibTerminal.appendChild(calibLine);
                calibTerminal.scrollTop = calibTerminal.scrollHeight;
            }
        }

        // Event listeners para sensores
        for (let i = 1; i <= 5; i++) {
            // Habilitar/deshabilitar sensor
            document.getElementById(`sensor${i}-enable`).addEventListener('change', function() {
                sensors[i].enabled = this.checked;
                const card = document.getElementById(`sensor${i}-card`);
                
                if (this.checked) {
                    card.classList.add('active');
                    sendCommand(`E${i}\n`);
                    sendCommand(`LON${i}\n`);
                } else {
                    card.classList.remove('active');
                    sendCommand(`D${i}\n`);
                    sendCommand(`LOFF${i}\n`);
                }
            });

            // Poner a cero
            document.getElementById(`sensor${i}-tare`).addEventListener('click', function() {
                const sensor = sensors[i];
                const btn = this;

                if (!sensor.isTared) {
                    if (sensor.values.length > 0) {
                        const lastValue = sensor.values[sensor.values.length - 1];
                        sensor.offset += lastValue;
                        sensor.isTared = true;
                        btn.textContent = 'Restaurar';
                    }
                } else {
                    sensor.offset = 0;
                    sensor.isTared = false;
                    btn.textContent = 'Poner a 0';
                }
            });

            // Establecer rango
            document.getElementById(`sensor${i}-set-range`).addEventListener('click', function() {
                const rangeValue = document.getElementById(`sensor${i}-range`).value;
                if (sendCommand(`R${i},${rangeValue}\n`)) {
                    sensors[i].maxRange = parseFloat(rangeValue);
                    addCommandToTerminal(`R${i},${rangeValue}`);
                    alert(`Comando enviado: establecer rango a ${rangeValue} mm`);
                }
            });
        }

        // Terminal principal
        document.getElementById('sendBtn').addEventListener('click', () => {
            const input = document.getElementById('terminalInput');
            const cmd = input.value.trim();
            if (cmd) {
                sendCommand(cmd + '\n');
                addCommandToTerminal(cmd);
                input.value = '';
            }
        });

        document.getElementById('terminalInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('sendBtn').click();
            }
        });

        document.getElementById('enterBtn').addEventListener('click', () => {
            sendCommand('\n');
            addCommandToTerminal('[ENTER]');
        });

        // Grabaci√≥n
        document.getElementById('recordBtn').addEventListener('click', function() {
            isRecording = !isRecording;

            if (isRecording) {
                startTime = Date.now();
                
                // Limpiar datos
                for (let i = 1; i <= 5; i++) {
                    sensors[i].values = [];
                    sensors[i].times = [];
                    sensors[i].allValues = [];
                    sensors[i].allTimes = [];
                    sensors[i].min = null;
                    sensors[i].max = null;
                    
                    const statsBox = document.getElementById(`sensor${i}-stats`);
                    statsBox.classList.remove('visible');
                }

                this.textContent = 'Detener Captura';
                this.classList.remove('btn-record');
                this.classList.add('btn-disconnect');
                addToTerminal('üî¥ Grabaci√≥n iniciada - Tiempo reiniciado a 0');
            } else {
                this.textContent = 'Iniciar Captura';
                this.classList.remove('btn-disconnect');
                this.classList.add('btn-record');
                addToTerminal('‚èπÔ∏è Grabaci√≥n detenida - Datos listos para exportar');
            }
        });

        // Exportar CSV
        document.getElementById('exportCsvBtn').addEventListener('click', () => {
            let csvContent = 'Tiempo (s)';
            const enabledSensors = [];

            for (let i = 1; i <= 5; i++) {
                if (sensors[i].enabled) {
                    csvContent += ',Sensor ' + i;
                    enabledSensors.push(i);
                }
            }
            csvContent += '\n';

            if (enabledSensors.length === 0) {
                alert('No hay sensores habilitados para exportar');
                return;
            }

            const maxLength = Math.max(...enabledSensors.map(i => sensors[i].allValues.length));

            for (let row = 0; row < maxLength; row++) {
                const time = sensors[enabledSensors[0]].allTimes[row];
                if (time !== undefined) {
                    csvContent += time.toFixed(4);

                    for (const sensorNum of enabledSensors) {
                        const value = sensors[sensorNum].allValues[row];
                        csvContent += ',' + (value !== undefined ? value.toFixed(4) : '');
                    }
                    csvContent += '\n';
                }
            }

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `datos_transductores_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            alert(`‚úÖ CSV exportado con ${enabledSensors.length} sensores`);
        });

        // Exportar PDF (simplificado - solo genera reporte de texto)
        document.getElementById('exportPdfBtn').addEventListener('click', () => {
            alert('‚ö†Ô∏è La exportaci√≥n a PDF requiere una librer√≠a adicional.\nPor ahora, usa la opci√≥n CSV para exportar los datos.');
        });

        // Calibraci√≥n
        function autoCalibrate() {
            const enabledSensors = [];
            for (let i = 1; i <= 5; i++) {
                if (sensors[i].enabled) {
                    enabledSensors.push(i);
                }
            }

            let currentIndex = 0;

            function calibrateNext() {
                if (currentIndex >= enabledSensors.length) {
                    addToTerminal('‚úÖ Calibraci√≥n autom√°tica completada');
                    return;
                }

                const sensorNum = enabledSensors[currentIndex];
                sendCommand(`LBLINK${sensorNum}\n`);
                sendCommand('C\n');
                addCommandToTerminal('C');

                setTimeout(() => {
                    sendCommand(`${sensorNum}\n`);
                    addCommandToTerminal(sensorNum.toString());
                    sendCommand(`LON${sensorNum}\n`);
                    currentIndex++;
                    setTimeout(calibrateNext, 500);
                }, 500);
            }

            if (enabledSensors.length > 0) {
                setTimeout(calibrateNext, 500);
            }
        }

        // Botones de calibraci√≥n manual
        for (let i = 1; i <= 5; i++) {
            document.getElementById(`calibrate${i}`).addEventListener('click', () => {
                sendCommand(`LBLINK${i}\n`);
                sendCommand('C\n');
                addCommandToTerminal('C');
                
                setTimeout(() => {
                    sendCommand(`${i}\n`);
                    addCommandToTerminal(i.toString());
                    sendCommand(`LON${i}\n`);
                }, 500);
            });
        }

        document.getElementById('saveCalibration').addEventListener('click', () => {
            sendCommand('S\n');
            addCommandToTerminal('S');
        });

        document.getElementById('calibrationEnter').addEventListener('click', () => {
            sendCommand('\n');
            addCommandToTerminal('[ENTER]');
        });

        document.getElementById('closeCalibration').addEventListener('click', () => {
            document.getElementById('calibrationModal').classList.remove('show');
        });

        // Inicializar
        initCharts();
    </script>
</body>
</html>